<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
            <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89717266-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-89717266-1');
        </script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
        <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/a11y-dark.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
        <link href="/css/base.css" rel="stylesheet">

        <title>Merry Belated Christmas</title>
    <link href="/css/blog.css" rel="stylesheet"></head>
    <body>
        <div class="content">
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="/feed.xml"><span class="small-caps">RSS</span></a></li>
            </ul> 
        </nav>
        
<article>
    <h1 class="title">Merry Belated Christmas</h1>
    <section><h2>Christmas in July</h2><p>It’s Independence Day when I’m writ­ing this, which seems like a good time to
write about my win­ter hol­i­day cards from last year. In a pre­vi­ous blog post, I
wrote about a small pro­ject I made with my
<a href="https://naitian.holiday/isyp">nait­ian.hol­i­day</a> do­main name.  However, that
was­n’t the orig­i­nal pur­pose for the do­main. The first use for the do­main was
dig­i­tal hol­i­day cards for some of my friends.</p></section>
<section><h2>Table of Contents</h2><ul>
<li><a href="#planning">Planning</a></li>
<li><a href="#implementation">Implementation</a>
<ul>
<li><a href="#infrastructure">Infrastructure</a></li>
<li><a href="#design">Design</a></li>
<li><a href="#build-process">Build Process</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#email-notifications">Email Notifications</a></li>
</ul>
</li>
</ul></section>
<section><h2>Planning</h2><blockquote>
<p><span class="small-caps">AKA</span> all the things I wanted to do but did­n’t.</p>
</blockquote><p>There were a cou­ple of clear re­quire­ments that were non-ne­go­tiable:</p><ol>
<li>There had to be at least some form of au­then­ti­ca­tion (so not every­one can see
every­one else’s card)</li>
<li>Emails would be sent out no­ti­fy­ing peo­ple of their cards.</li>
<li>Cards need to be per­son­al­ized with:
<ul>
<li>Greeting</li>
<li>Name (duh)</li>
<li>Message</li>
</ul>
</li>
</ol><p>Later, I also de­cided a cou­ple more re­quire­ments, both for fun and for
ed­u­ca­tion:</p><ol>
<li>Everything would be com­piled and hosted sta­t­i­cally on <span class="small-caps">S3</span>.</li>
<li>In the theme of us­ing <span class="small-caps">AWS</span> for every­thing, I’d also send email no­ti­fi­ca­tions
with Amazon’s Simple Email Service (<span class="small-caps">SES</span>) and han­dle do­main name /
certificates with Route53.</li>
<li>Each per­son would only see pretty URLs (e.g. nait­ian.hol­i­day/​nate)</li>
<li>Cards would in­clude these drag­gable Polaroid-style pic­tures from my Google
Photos.</li>
</ol></section>
<section><h2>Implementation</h2><blockquote>
<p><span class="small-caps">AKA</span> what I ended up do­ing</p>
</blockquote><h3>Infrastructure</h3><p>I will be to­tally hon­est with you and say I don’t ac­tu­ally re­mem­ber all the
de­tails to the in­fra­struc­ture on <span class="small-caps">AWS</span>, but it was­n’t su­per com­plex. The gist is:</p><ul>
<li>All the sta­tic files are hosted with S3′s sta­tic web­site host­ing.</li>
<li>I used Cloudfront as the <span class="small-caps">CDN</span> for the <span class="small-caps">S3</span> files.</li>
<li>I have a hosted zone for <code>naitian.holiday</code> in Route53 which points to the
Cloud­front end­point (which in turn points to the <span class="small-caps">S3</span> bucket).</li>
<li>Photos were hosted on Google Photos</li>
</ul><h3>Design</h3><p>Aesthetically, I de­cided to go for a fes­tive red with a sub­tle gra­di­ent. I chose
a classy serif type­face and drew this freak­ing amaz­ing <del>Christmas</del>
non-denominational hol­i­day tree.</p><h3>Build Process</h3><p>Each card was de­fined as a yaml file. I wrote a Python script to read these yaml
files and used mark­down to ren­der them into <span class="small-caps">HTML</span> files. At the same time, I
generated the <span class="small-caps">SES</span> email tem­plate data for bulk send­ing the no­ti­fi­ca­tion emails.</p><p>I also had a Makefile which would run the ren­der­ing script, com­pile the SCSS
into <span class="small-caps">CSS</span>, minify <span class="small-caps">CSS</span> and <span class="small-caps">JS</span>, and push every­thing to <span class="small-caps">S3</span>. There were also Make
steps which would send a test email and send out the ac­tual emails.</p><h3>Authentication</h3><p>One of the most in­ter­est­ing parts of this whole ex­er­cise was fig­ur­ing out a good
au­then­ti­ca­tion method. I def­i­nitely did not want to make any­one sign in or
cre­ate any ac­counts (partly also be­cause I wanted this to be a to­tally sta­tic
site).</p><p>I ended up com­pro­mis­ing with a<span class="push-double"></span> <span class="pull-double">“</span>good-enough” au­then­ti­ca­tion plan, which I had to
al­ter a lit­tle bit to also keep the pretty URLs. Here’s how it ended up work­ing:</p><ol>
<li>When a card is ren­dered, it is ac­tu­ally placed in a di­rec­tory named af­ter its
SHA256 hash.</li>
<li>This hash is used as an auth to­ken in the link.</li>
<li>Not only is an <span class="small-caps">HTML</span> file gen­er­ated with the card’s con­tent, an­other <span class="small-caps">HTML</span> page
is gen­er­ated with Javascript for au­then­ti­ca­tion and a hid­den in­put field
con­tain­ing a <span class="small-caps">SHA256</span> hash of the to­ken.</li>
<li>When a user nav­i­gates to the site (e.g. nait­ian.holidy/​nate), they are
ac­tu­ally nav­i­gat­ing to the page with only the auth code.
<ul>
<li>On the client side, the to­ken (if it’s pre­sent) is hashed and com­pared
to the cor­rect to­ken.</li>
<li>If in­cor­rect, the user is re­jected.</li>
</ul>
</li>
<li>If cor­rect, there is an <span class="small-caps">XHR</span> re­quest that fetches the ac­tual <span class="small-caps">HTML</span> and dis­plays
it.</li>
</ol><p>This means the user would have a hard time even re­al­iz­ing that any
au­then­ti­ca­tion had oc­curred in the first place.</p><p>To re­cap, for each card, the path struc­ture looked like this:</p><pre><code class="hljs language-axapta">naitian.holiday/&#x3C;SHA256>/<span class="hljs-keyword">index</span>.html   &#x3C;- <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> the HTML <span class="hljs-keyword">for</span> the card
naitian.holiday/nate/<span class="hljs-keyword">index</span>.html       &#x3C;- <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> the HTML <span class="hljs-keyword">for</span> authentication
</code></pre><p>Of course, I also added a <code>robots.txt</code> which dis­al­lowed any crawl­ing. This makes
it pretty dif­fi­cult to find the (very much pub­lic) <span class="small-caps">SHA256</span> paths of any of the
cards.</p><p>So, while not air­tight, this worked well enough to pre­vent peo­ple from just
typ­ing in names of other peo­ple to see their cards.</p><p>I also stored the to­kens in lo­cal stor­age, so af­ter the first visit, the to­ken
is­n’t ac­tu­ally re­quired.</p><p>Nifty.</p><h3>Email Notifications</h3><p>Emails were sur­pris­ingly straight­for­ward to set up. I used the Simple Email
Service from Amazon. Initially, I planned to do a lot more <span class="small-caps">CSS</span> for the HTML
emails, but ul­ti­mately de­cided against it for two rea­sons: it would have been
more work to im­ple­ment and try to test, and I felt like it would feel more
per­sonal if it was more<span class="push-double"></span> <span class="pull-double">“</span>raw”.</p><p>I had a <code>make</code> rule which would send just test emails to my­self and a dif­fer­ent
rule to send out the emails for real.</p></section>
</article>

        </div>
    </body>
</html>
